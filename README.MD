# Laboratorio Nmap + Nessus - Gu√≠a Completa

> **Laboratorio de escaneo de vulnerabilidades y an√°lisis de seguridad**  
> Gu√≠a pr√°ctica para montar y ejecutar un laboratorio completo de Nmap, NSE y Nessus con integraci√≥n de herramientas.

## Tabla de Contenidos

- [Objetivos del Laboratorio](#objetivos-del-laboratorio)
- [Arquitectura del Laboratorio](#arquitectura-del-laboratorio)
- [Opciones de Instalaci√≥n](#opciones-de-instalaci√≥n)
  - [Opci√≥n Docker (Recomendada)](#opci√≥n-docker-recomendada)
  - [Opci√≥n M√°quinas Virtuales](#opci√≥n-m√°quinas-virtuales)
- [M√≥dulos del Laboratorio](#m√≥dulos-del-laboratorio)
- [Ejercicios Pr√°cticos](#ejercicios-pr√°cticos)
- [Herramientas y Scripts](#herramientas-y-scripts)
- [Reportes y An√°lisis](#reportes-y-an√°lisis)
- [Consideraciones de Seguridad](#consideraciones-de-seguridad)

---

## Objetivos del Laboratorio

* **Entender diferencias** entre escaneo de red, detecci√≥n de servicios, detecci√≥n de versiones y an√°lisis de vulnerabilidades
* **Dominar Nmap**: opciones, timing, t√©cnicas avanzadas y scripting (NSE)
* **Dominar Nessus**: creaci√≥n de pol√≠ticas, escaneos credentialed vs non-credentialed, interpretaci√≥n de plugins y reportes
* **Integrar resultados**: exportar, correlacionar Nmap y Nessus y priorizar remediaciones
* **Automatizar procesos**: scripts Python para procesamiento y an√°lisis de datos

---

## Arquitectura del Laboratorio

### Red del Laboratorio
- **Subnet**: `10.10.0.0/24`
- **Gateway**: `10.10.0.1` (opcional)
- **Aislada**: Completamente separada de redes de producci√≥n

### Componentes del Laboratorio

| Componente | IP | Funci√≥n | Acceso |
|------------|----|---------|---------| 
| **Kali Linux** | 10.10.0.10 | Herramientas de escaneo y ataque | SSH:2222, Burp:8081 |
| **Metasploitable** | 10.10.0.20 | Sistema Linux vulnerable | SSH:2220, Web:8050, SMB:8082 |
| **DVWA** | 10.10.0.30 | Aplicaci√≥n web vulnerable | HTTP:8180, MySQL:8330 |
| **Windows Target** | 10.10.0.40 | Simulador Windows | RDP:8149, SMB:8445 |
| **Nessus** | 10.10.0.100 | Esc√°ner de vulnerabilidades | Web UI:8834 (Simulador) |
| **Elasticsearch** | 10.10.0.50 | Motor de b√∫squeda | API:9200 |
| **Kibana** | 10.10.0.60 | Visualizaci√≥n de datos | Web UI:5601 |

---

## Opciones de Instalaci√≥n

### Opci√≥n Docker (Recomendada)

**Ventajas**: Portabilidad, facilidad de uso, aislamiento completo, r√°pido setup

#### Prerrequisitos
- Docker Desktop o Docker Engine
- Docker Compose v3.8+
- 4GB+ RAM, 10GB+ espacio en disco
- Python 3.7+ (para scripts auxiliares)

#### Instalaci√≥n Express
```bash
# 1. Clonar repositorio
git clone https://github.com/la00429/Laboratorio_Nessus_Nmap_.git
cd Laboratorio_Nessus_Nmap_

# 2. Configurar autom√°ticamente
chmod +x setup.sh
./setup.sh

# 3. Iniciar laboratorio
docker-compose up -d

# 4. Verificar estado
make status
# o
python3 scripts/docker-lab-helper.py status
```

#### Acceso Inmediato
- **Kali Linux**: `ssh root@localhost -p 2222` (password: kali123)
- **Nessus**: https://localhost:8834 (admin/admin123) - **Simulador funcional**
- **DVWA**: http://localhost:8180 (admin/password)
- **Metasploitable**: `ssh msfadmin@localhost -p 2220` (password: msfadmin)
- **Kibana**: http://localhost:5601 (ELK Stack para an√°lisis)

#### Comandos √ötiles Docker
```bash
# Gesti√≥n del laboratorio
make start          # Iniciar todo
make stop           # Detener todo
make restart        # Reiniciar
make status         # Ver estado
make logs           # Ver logs
make fix            # Solucionar problemas de im√°genes

# Acceso a contenedores
make shell-kali     # Acceder a Kali
make shell-nessus   # Acceder a Nessus
make shell-dvwa     # Acceder a DVWA

# Herramientas
make nmap-scan      # Escaneo b√°sico
make test-connectivity # Probar conectividad
make interactive    # Modo interactivo

# Limpieza completa
docker-compose down -v  # Detener y eliminar vol√∫menes
docker system prune -f  # Limpiar sistema Docker
docker-compose build --no-cache  # Reconstruir sin cach√©
```

#### Documentaci√≥n Docker
- **[Gu√≠a de Inicio R√°pido](docs/QUICKSTART.md)** - Tener el lab funcionando en 10 minutos
- **[Configuraci√≥n Completa](docs/DOCKER_SETUP.md)** - Documentaci√≥n detallada

---

### Opci√≥n M√°quinas Virtuales

**Ventajas**: Control total, simulaci√≥n real de hardware, flexibilidad avanzada

#### Prerrequisitos
- VirtualBox, VMware o Proxmox
- 8GB+ RAM, 50GB+ espacio en disco
- Snapshot capabilities
- Red host-only o NAT interna

#### Configuraci√≥n de VMs

##### Kali Linux VM
- **OS**: Kali Linux 2023.x
- **RAM**: 2GB m√≠nimo
- **Disco**: 20GB
- **IP**: 10.10.0.10
- **Herramientas**: nmap, python3, metasploit

##### Metasploitable2 VM
- **OS**: Ubuntu 8.04 LTS (Metasploitable2)
- **RAM**: 1GB
- **Disco**: 10GB
- **IP**: 10.10.0.20
- **Credenciales**: msfadmin/msfadmin, root/password

##### DVWA VM
- **OS**: Ubuntu 20.04 LTS
- **RAM**: 1GB
- **Disco**: 10GB
- **IP**: 10.10.0.21
- **Servicios**: Apache, MySQL, DVWA

##### Windows Target VM
- **OS**: Windows Server 2019/2022
- **RAM**: 2GB
- **Disco**: 25GB
- **IP**: 10.10.0.30
- **Servicios**: IIS, SMB, RDP

##### Nessus VM
- **OS**: Ubuntu 20.04 LTS
- **RAM**: 2GB
- **Disco**: 20GB
- **IP**: 10.10.0.100
- **Puerto**: 8834

#### Configuraci√≥n de Red VM
```bash
# VirtualBox - Crear red host-only
VBoxManage hostonlyif create
VBoxManage hostonlyif ipconfig vboxnet0 --ip 10.10.0.1 --netmask 255.255.255.0

# Configurar VMs para usar red host-only
# Asignar IPs est√°ticas en cada VM
```

#### Documentaci√≥n VM
- **[Gu√≠a Original](guia.md)** - Instrucciones detalladas para VMs
- **[Esquema de Red](esquema.dot)** - Diagrama de la arquitectura

---

## M√≥dulos del Laboratorio

### M√≥dulo 1: Fundamentos y Reconocimiento (Nmap B√°sico)

#### Teor√≠a
- **ARP/ICMP**: Detecci√≥n de hosts vivos
- **TCP SYN scan (-sS)**: R√°pido, requiere privilegios
- **Connect scan (-sT)**: Sin privilegios, m√°s ruidoso
- **UDP scan (-sU)**: Lento, necesario para servicios UDP
- **Service/version (-sV)**: Identificaci√≥n de software
- **OS detection (-O)**: Fingerprinting de la pila TCP/IP
- **Timing templates (-T0..-T5)**: Trade-off velocidad vs detecci√≥n

#### Ejercicios Pr√°cticos
```bash
# 1. Ping sweep (descubrir hosts vivos)
nmap -sn 10.10.0.0/24 -oN resultados/ping_sweep.txt

# 2. Escaneo SYN r√°pido
sudo nmap -sS -Pn -p 1-65535 10.10.0.20 -T4 -oA resultados/syn_scan_metasploitable

# 3. Detecci√≥n de versiones
sudo nmap -sS -sV -p 22,80,139,445,3306 10.10.0.20 -oN resultados/versiones.txt

# 4. Escaneo UDP b√°sico
sudo nmap -sU -p 53,67,123 10.10.0.20 -T3 -oN resultados/udp.txt

# 5. Detecci√≥n de OS
sudo nmap -O 10.10.0.40 -oN resultados/os_detect.txt

# 6. Escaneo agresivo (combinado)
sudo nmap -A -T4 10.10.0.20 -oN resultados/agresivo.txt

# 7. Escaneo web espec√≠fico
sudo nmap -p80,443 --script=http-* 10.10.0.30 -oA resultados/dvwa_web
```

### M√≥dulo 2: NSE (Nmap Scripting Engine)

#### Teor√≠a
- **Tipos de scripts**: auth, discovery, vuln, brute, safe, intrusive
- **Ubicaci√≥n**: `/usr/share/nmap/scripts/` (Kali)
- **Uso**: `--script <name>` o `--script <category>`

#### Ejercicios Pr√°cticos
```bash
# 1. Scripts de vulnerabilidad
sudo nmap -sS -sV --script=vuln 10.10.0.20 -oN resultados/nse_vuln.txt

# 2. Scripts HTTP espec√≠ficos
sudo nmap -p80 --script=http-enum,http-vuln-cve2017-5638 10.10.0.30 -oN resultados/http_nse.txt

# 3. Script personalizado
sudo nmap -sV --script my-banner 10.10.0.20 -oN resultados/my_banner.txt

# 4. Scripts SMB para Windows Target
sudo nmap -p445 --script=smb-* 10.10.0.40 -oN resultados/smb_nse.txt

# 5. Scripts de autenticaci√≥n
sudo nmap --script=auth 10.10.0.20,10.10.0.30 -oN resultados/auth_nse.txt
```

### M√≥dulo 3: Procesamiento y Automatizaci√≥n (Python)

#### Objetivo
Parsear salida XML de Nmap y generar resumen (CSV/JSON) de puertos abiertos, servicios y hosts.

#### Scripts Disponibles
```bash
# Parsear resultados XML
python3 scripts/parse_nmap_xml.py resultados/scan.xml --csv reports/summary.csv --json reports/summary.json

# Helper interactivo (solo Docker)
python3 scripts/docker-lab-helper.py interactive

# Importar a Nessus
./scripts/import_nmap_to_nessus.sh -x resultados/scan.xml -n "Nmap Discovery" -t "10.10.0.20-30"
```

### M√≥dulo 4: Nessus - Teor√≠a y Pr√°ctica

#### Fundamentos
- **Plugins**: Sistema de detecci√≥n de vulnerabilidades
- **Credentialed scans**: Con credenciales, descubren parches y configuraciones internas
- **Non-credentialed scans**: Visi√≥n externa, detecci√≥n de servicios visibles
- **CVSS**: Usar para priorizar; considerar contexto y falsos positivos

#### Ejercicios Pr√°cticos
1. **Escaneo b√°sico non-credentialed**
   - Template: Basic Network Scan
   - Objetivos: `10.10.0.20-30`
   - Exportar PDF/HTML

2. **Escaneo credentialed (Linux)**
   - Configurar Credentials ‚Üí SSH (username/key)
   - Ejecutar, comparar findings

3. **Ajuste performance/exclusiones**
   - Max simultaneous hosts, Scan timeout

---

## Ejercicios Pr√°cticos

### Flujo de Trabajo Completo

#### 1. Descubrimiento de Red
```bash
# Descubrir hosts vivos
nmap -sn 10.10.0.0/24

# Escanear puertos en hosts descubiertos
nmap -sS -sV 10.10.0.20 10.10.0.30 10.10.0.40
```

#### 2. An√°lisis Detallado
```bash
# Escaneo completo con scripts
nmap -A -sV --script=vuln 10.10.0.20 -oA resultados/metasploitable_full

# Escaneo espec√≠fico por servicios
nmap -p80,443 --script=http-* 10.10.0.30 -oA resultados/dvwa_web

# Escaneo Windows Target
nmap -sS -sV --script=smb-* 10.10.0.40 -oA resultados/windows_target
```

#### 3. Procesamiento de Resultados
```bash
# Parsear XML a formatos √∫tiles
python3 scripts/parse_nmap_xml.py resultados/metasploitable_full.xml --csv reports/metasploitable.csv --json reports/metasploitable.json

# Importar a Nessus para an√°lisis adicional
./scripts/import_nmap_to_nessus.sh -x resultados/metasploitable_full.xml -n "Metasploitable Analysis"
```

#### 4. An√°lisis con Nessus
1. Acceder a Nessus Web UI
2. Crear pol√≠tica de escaneo
3. Configurar targets basados en resultados de Nmap
4. Ejecutar escaneos credentialed y non-credentialed
5. Analizar plugins y CVSS
6. Exportar reportes

---

## Herramientas y Scripts

### Scripts de Automatizaci√≥n

#### `parse_nmap_xml.py`
- **Funci√≥n**: Procesa archivos XML de Nmap
- **Salidas**: CSV, JSON, resumen ejecutivo
- **Uso**: `python3 scripts/parse_nmap_xml.py scan.xml --csv report.csv --json report.json`

#### `import_nmap_to_nessus.sh`
- **Funci√≥n**: Prepara importaci√≥n de resultados Nmap a Nessus
- **Caracter√≠sticas**: Extrae hosts, crea targets, genera instrucciones
- **Uso**: `./scripts/import_nmap_to_nessus.sh -x scan.xml -n "Scan Name"`

#### `docker-lab-helper.py` (Solo Docker)
- **Funci√≥n**: Gesti√≥n completa del laboratorio Docker
- **Caracter√≠sticas**: Inicio/parada, verificaci√≥n, escaneos automatizados
- **Uso**: `python3 scripts/docker-lab-helper.py interactive`

### Scripts NSE Personalizados

#### `my-banner.nse`
- **Funci√≥n**: Extrae banners de servicios TCP
- **Categor√≠a**: discovery, safe
- **Uso**: `nmap -sV --script my-banner target`

### Herramientas del Laboratorio

#### Kali Linux
- **Nmap**: Escaneo de red y puertos
- **Python**: Scripts de automatizaci√≥n
- **Herramientas adicionales**: masscan, zmap, nikto, dirb

#### Nessus
- **Web UI**: Interfaz gr√°fica completa
- **API**: Automatizaci√≥n de escaneos
- **Plugins**: Base de datos de vulnerabilidades

---

## Reportes y An√°lisis

### Formato de Reportes

#### Resumen Ejecutivo
```
T√≠tulo: [Basic Network Scan - non-credentialed]
Fecha: 2025-01-15 10:00 UTC-5
Objetivo: 10.10.0.20-30
Comando: nmap -sS -sV -oX resultados/scan.xml
Tiempo ejecuci√≥n: 00:12:34

Resumen ejecutivo:
  - Hosts vivos: 3
  - Puertos abiertos: 45
  - Hallazgos critical: 2
  - Hallazgos high: 8
```

#### Tabla de Hallazgos
| Host | Puerto | Servicio | Plugin/CVE | Severidad | Recomendaci√≥n |
|------|--------|----------|------------|-----------|---------------|
| 10.10.0.20 | 80 | http | CVE-2021-44228 | Critical | Actualizar Apache |
| 10.10.0.30 | 3306 | mysql | CVE-2020-1472 | High | Cambiar credenciales |
| 10.10.0.40 | 445 | smb | CVE-2020-1472 | High | Parchear SMB |

### Correlaci√≥n Nmap ‚Üî Nessus

#### Procedimiento
1. Ejecutar Nmap discovery (`-oX`) para obtener puertos abiertos
2. Importar Nmap XML a Nessus o usar CSV del parser
3. Filtrar findings de Nessus por host/puerto
4. Priorizar por severidad y contexto

#### Reglas de Priorizaci√≥n
- `Critical` plugin sobre servicio expuesto ‚Üí **Prioridad Alta**
- `High` plugin en servicio con puerto abierto y versi√≥n vulnerable ‚Üí **Prioridad Media-Alta**
- Falsos positivos confirmados manualmente ‚Üí **Bajar prioridad**

---

## Consideraciones de Seguridad

### Buenas Pr√°cticas

#### Aislamiento
- **Laboratorio aislado**: Nunca conectar a redes de producci√≥n
- **Red host-only**: Aislar completamente del resto de la red
- **Snapshots**: Hacer backup antes de cambios importantes

#### Credenciales
- **Cambiar por defecto**: Modificar contrase√±as de ejemplo
- **Almacenar seguras**: No commitear credenciales reales
- **Rotaci√≥n**: Cambiar peri√≥dicamente en entornos de prueba

#### Monitoreo
- **Logs**: Mantener registro de todas las actividades
- **Alertas**: Configurar notificaciones de actividades sospechosas
- **Auditor√≠a**: Revisar regularmente accesos y cambios

### Advertencias Importantes

**NUNCA** escanear activos fuera del laboratorio sin autorizaci√≥n expl√≠cita  
**NUNCA** usar credenciales reales en sistemas de producci√≥n  
**SIEMPRE** documentar pruebas de explotaci√≥n y revertir cambios  
**SIEMPRE** evitar escaneos intrusivos en entornos productivos  

---

## Checklist Final

### Configuraci√≥n Inicial
- [ ] Red del laboratorio aislada y configurada
- [ ] Todas las VMs/contenedores funcionando
- [ ] Conectividad entre todos los componentes
- [ ] Credenciales configuradas y documentadas
- [ ] Snapshots/backups realizados

### Ejercicios Completados
- [ ] M√≥dulo 1: Nmap b√°sico y reconocimiento
- [ ] M√≥dulo 2: Scripts NSE y vulnerabilidades
- [ ] M√≥dulo 3: Procesamiento y automatizaci√≥n
- [ ] M√≥dulo 4: Nessus y an√°lisis avanzado

### Entregables
- [ ] Resultados Nmap en m√∫ltiples formatos
- [ ] Scripts NSE personalizados documentados
- [ ] Scripts Python funcionando y probados
- [ ] Reportes Nessus exportados
- [ ] An√°lisis de correlaci√≥n Nmap-Nessus
- [ ] Documentaci√≥n de hallazgos y recomendaciones

### Limpieza
- [ ] Datos sensibles eliminados
- [ ] Credenciales de prueba cambiadas
- [ ] Logs y resultados archivados
- [ ] Sistema restaurado a estado inicial

---

## Soporte y Recursos

### Documentaci√≥n Adicional
- **[Comparaci√≥n Docker vs VMs](docs/COMPARISON.md)** - Gu√≠a para elegir la mejor opci√≥n
- **[Gu√≠a Docker](docs/DOCKER_SETUP.md)** - Configuraci√≥n completa con contenedores
- **[Inicio R√°pido](docs/QUICKSTART.md)** - Setup en 10 minutos
- **[Gu√≠a Original](guia.md)** - Instrucciones detalladas para VMs

### Comandos de Ayuda
```bash
# Docker
make help                    # Ver todos los comandos
python3 scripts/docker-lab-helper.py interactive  # Modo interactivo

# VMs
# Consultar guia.md para comandos espec√≠ficos
```

### Resoluci√≥n de Problemas

#### Problemas Comunes Docker
1. **Contenedores reinici√°ndose**:
   ```bash
   # Ver logs del contenedor problem√°tico
   docker-compose logs [nombre-contenedor]
   
   # Reconstruir imagen espec√≠fica
   docker-compose build --no-cache [nombre-contenedor]
   ```

2. **Problemas de im√°genes**:
   ```bash
   # Ejecutar script de reparaci√≥n
   make fix
   # o
   ./fix-docker.sh
   ```

3. **Puertos ocupados**:
   ```bash
   # Verificar puertos en uso (Windows)
   netstat -an | findstr :2222
   
   # Cambiar puertos en docker-compose.yml si es necesario
   ```

4. **Limpieza completa**:
   ```bash
   # Detener todo y limpiar
   docker-compose down -v
   docker system prune -f
   docker-compose build --no-cache
   docker-compose up -d
   ```

#### Problemas Comunes VMs
1. **Verificar conectividad**: `ping` entre todos los componentes
2. **Revisar logs**: Docker logs o logs de VMs
3. **Verificar recursos**: RAM, CPU, espacio en disco
4. **Consultar documentaci√≥n**: Gu√≠as espec√≠ficas por plataforma

#### Mejoras Implementadas
- **DVWA**: Corregido comando Apache para Ubuntu 20.04
- **Metasploitable**: Agregado loop de supervisi√≥n de servicios
- **Windows Target**: Optimizado entrypoint con supervisi√≥n
- **Nessus**: Simulador funcional para prop√≥sitos educativos
- **Kali**: Configuraci√≥n SSH mejorada y librer√≠as Python actualizadas

---

## Licencia

Este laboratorio est√° dise√±ado √∫nicamente para fines educativos. Ver archivo `LICENSE` para m√°s detalles.

---

---

## Estado Actual del Laboratorio

### ‚úÖ **Laboratorio Completamente Funcional**

| Componente | Estado | √öltima Actualizaci√≥n |
|------------|--------|---------------------|
| **Docker Compose** | ‚úÖ Funcionando | Enero 2025 |
| **Todos los Contenedores** | ‚úÖ Estables | Enero 2025 |
| **Correcciones Aplicadas** | ‚úÖ Completadas | Enero 2025 |
| **Documentaci√≥n** | ‚úÖ Actualizada | Enero 2025 |

### üîß **Correcciones Implementadas**
- ‚úÖ DVWA: Apache corregido para Ubuntu 20.04
- ‚úÖ Metasploitable: Supervisi√≥n de servicios mejorada
- ‚úÖ Windows Target: Entrypoint optimizado
- ‚úÖ Nessus: Simulador funcional implementado
- ‚úÖ Kali: SSH y Python configurados correctamente
- ‚úÖ Puertos: Conflictos resueltos (8081, 8082)

### üöÄ **Listo para Usar**
El laboratorio est√° completamente operativo y listo para ejercicios de seguridad. Todos los contenedores est√°n funcionando correctamente sin reinicios.

---

**¬°Happy Hacking!** üéâ

> Laboratorio creado para Redes de Datos 
> Versi√≥n Docker y VM - 2025  
> **Estado**: ‚úÖ Completamente Funcional